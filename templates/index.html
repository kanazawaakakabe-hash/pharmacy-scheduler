<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–¬å±€ç´å“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«(Ver 5.1)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body { background-color: #f4f7f6; }
        .start-date-box { 
            background: linear-gradient(135deg, #e6ffe6 0%, #ffffff 100%); 
            border: 2px solid #28a745; 
            padding: 30px; 
            margin-bottom: 30px; 
            text-align: center; 
            border-radius: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .gantt-chart-container { 
            width: 100%; 
            overflow-x: auto; 
            margin-top: 20px; 
            border: 1px solid #dee2e6; 
            padding: 20px; 
            border-radius: 15px; 
            background: #fff; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .delivery-box { 
            border: none; 
            padding: 25px; 
            margin-bottom: 30px; 
            background-color: #ffffff; 
            border-radius: 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        }
        .process-input-group { margin-bottom: 10px; }
        h4 { color: #2c3e50; font-weight: bold; border-left: 6px solid #007bff; padding-left: 15px; margin-bottom: 25px; }
        .table { border-radius: 10px; overflow: hidden; }
        .btn-primary { border-radius: 30px; font-weight: bold; }
        .btn-success { border-radius: 30px; }
    </style>
</head>
<body>

<div class="container mt-5">
    <h1 class="text-center mb-4" style="color: #2c3e50; font-weight: 800;">è–¬å±€ç´å“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
    <p class="text-center text-muted mb-5">Ver 5.1: ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºãƒ»è­¦å‘Šä¿®æ­£ç‰ˆ</p>
    
    <div class="start-date-box">
        <h5 class="text-muted">å…¨ä½“ã®ç™ºæ³¨é–‹å§‹æœŸé™ï¼ˆæœ€ã‚‚æ—©ã„æ—¥ï¼‰</h5>
        <h2 class="text-success" style="font-size: 3rem; font-weight: 900;">
            {{ global_start_date if global_start_date else '---' }}
        </h2>
    </div>

    {% if all_schedules %}
    <div class="gantt-chart-container">
        <h5 class="mb-4">ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h5>
        <div id="timelineChart" style="width: 100%; min-height: 250px;"></div>
    </div>
    {% endif %}

    <div class="card p-4 mt-5 shadow-sm border-0" style="border-radius: 15px;">
        <h4>1. å·¥ç¨‹åã®å…±é€šè¨­å®š</h4>
        <p class="text-muted small">â€»ã“ã“ã§è¨­å®šã—ãŸå·¥ç¨‹ãŒã™ã¹ã¦ã®ç´å“å…ˆã«è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
        <div id="processNameContainer">
            {% for name in process_names_form %}
            <div class="input-group process-input-group">
                <input type="text" class="form-control" name="process_name[]" value="{{ name }}" required>
                <button type="button" class="btn btn-outline-danger remove-process-btn">å‰Šé™¤</button>
            </div>
            {% endfor %}
        </div>
        <button type="button" class="btn btn-outline-success btn-sm mt-3 w-25" id="addProcessBtn">+ å·¥ç¨‹ã‚’è¿½åŠ </button>
    </div>

    <form method="POST" id="mainForm" class="mt-5">
        <h4>2. ç´å“å…ˆã¨æ—¥æ•°ã®å…¥åŠ›</h4>
        <div id="deliveryContainer">
            {% for i in range(delivery_names_form|length) %}
            <div class="delivery-box" data-delivery-index="{{ i }}">
                <div class="row align-items-end mb-4">
                    <div class="col-md-5">
                        <label class="form-label fw-bold">ç´å“å…ˆå</label>
                        <input type="text" class="form-control form-control-lg" name="delivery_name[]" value="{{ delivery_names_form[i] }}" required>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label text-primary fw-bold">æœ€çµ‚ç´å“å¸Œæœ›æ—¥</label>
                        <input type="date" class="form-control form-control-lg border-primary" name="delivery_date_{{ i }}" value="{{ request.form.get('delivery_date_' ~ i) }}" required>
                    </div>
                    <div class="col-md-2 text-end">
                        <button type="button" class="btn btn-link text-danger remove-delivery-btn text-decoration-none">âœ– å‰Šé™¤</button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 60%;">å·¥ç¨‹å</th>
                                <th style="width: 40%;">æ‰€è¦æ—¥æ•°ï¼ˆå–¶æ¥­æ—¥ï¼‰</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p_index in range(process_names_form|length) %}
                            <tr>
                                <td>{{ process_names_form[p_index] }}</td>
                                <td>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="process_{{ p_index }}_days_{{ i }}" value="{{ process_days_form.get('process_' ~ p_index ~ '_days_' ~ i, '1') }}" min="0" required>
                                        <span class="input-group-text">æ—¥</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-5 mb-5 pb-5">
            <button type="button" class="btn btn-success btn-lg px-4" id="addDeliveryBtn">ï¼‹ ç´å“å…ˆã‚’è¿½åŠ </button>
            <button type="submit" class="btn btn-primary btn-lg px-5 shadow-lg" style="background-color: #007bff; border: none;">
                ğŸš€ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é€†ç®—ã™ã‚‹
            </button>
        </div>
    </form>
</div>

<script>
    google.charts.load('current', {'packages':['timeline']});
    google.charts.setOnLoadCallback(drawChart);

    function parseDate(dateStr) {
        if (!dateStr) return null;
        const p = dateStr.split('-');
        return new Date(p[0], p[1] - 1, p[2]);
    }

    function drawChart() {
        const container = document.getElementById('timelineChart');
        if (!container) return;

        const chart = new google.visualization.Timeline(container);
        const dataTable = new google.visualization.DataTable();

        dataTable.addColumn({ type: 'string', id: 'Delivery' });
        dataTable.addColumn({ type: 'string', id: 'Process' });
        dataTable.addColumn({ type: 'date', id: 'Start' });
        dataTable.addColumn({ type: 'date', id: 'End' });

        const schedules = JSON.parse('{{ all_schedules | tojson | safe }}');
        const rows = [];

        schedules.forEach(delivery => {
            delivery.schedule.forEach(task => {
                rows.push([
                    delivery.delivery_name,
                    task.name,
                    parseDate(task.start),
                    parseDate(task.end)
                ]);
            });
        });

        if (rows.length === 0) return;
        dataTable.addRows(rows);

        const options = {
            height: schedules.length * 80 + 100,
            timeline: { 
                groupByRowLabel: true,
                rowLabelStyle: { fontSize: 14, color: '#333' },
                barLabelStyle: { fontSize: 11 }
            },
            // â˜… ã‚«ãƒ©ãƒ¼è¨­å®šã‚’å›ºå®šé…åˆ—ã«ã™ã‚‹ã“ã¨ã§ 'undefined' è­¦å‘Šã‚’è§£æ¶ˆ
            colors: ['#3366cc', '#dc3912', '#ff9900', '#109618', '#990099', '#0099c6', '#dd4477', '#66aa00']
        };

        chart.draw(dataTable, options);
    }

    // å·¥ç¨‹è¿½åŠ 
    document.getElementById('addProcessBtn').addEventListener('click', () => {
        const container = document.getElementById('processNameContainer');
        const div = document.createElement('div');
        div.className = 'input-group process-input-group';
        div.innerHTML = `
            <input type="text" class="form-control" name="process_name[]" placeholder="æ–°ã—ã„å·¥ç¨‹å" required>
            <button type="button" class="btn btn-outline-danger remove-process-btn">å‰Šé™¤</button>
        `;
        container.appendChild(div);
    });

    // å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå§”è­²ï¼‰
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-process-btn')) {
            e.target.closest('.input-group').remove();
        }
        if (e.target.classList.contains('remove-delivery-btn')) {
            if(document.querySelectorAll('.delivery-box').length > 1) {
                e.target.closest('.delivery-box').remove();
            } else {
                alert("ç´å“å…ˆã¯æœ€ä½1ã¤å¿…è¦ã§ã™ã€‚");
            }
        }
    });

    // ç´å“å…ˆè¿½åŠ 
    document.getElementById('addDeliveryBtn').addEventListener('click', () => {
        alert("ç¾åœ¨ã®è¨­å®šã§ä¸€åº¦ã€Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é€†ç®—ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚æœ€æ–°ã®å·¥ç¨‹ãƒªã‚¹ãƒˆã«åŸºã¥ã„ã¦æ–°ã—ã„å…¥åŠ›æ¬„ãŒä½œæˆã•ã‚Œã¾ã™ã€‚");
    });
</script>

</body>
</html>