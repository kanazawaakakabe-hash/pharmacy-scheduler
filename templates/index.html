<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>薬局納品スケジュールシミュレーター</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-dayjs-4@1.0.1/dist/chartjs-adapter-dayjs-4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
    
    <style>
        .process-input-group {
            margin-bottom: 10px;
        }
        .gantt-chart-container {
            width: 100%;
            height: 400px; /* ガントチャートの高さを固定 */
            margin-top: 20px;
        }
        .start-date-box {
            background-color: #e6ffe6;
            border: 1px solid #c6e6c6;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .delivery-box {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f8f8f8;
        }
        .process-days-input {
            width: 80px; /* 所要日数の入力幅を調整 */
        }
        .process-list-container {
            max-height: 400px; 
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h1 class="text-center mb-4">薬局納品スケジュールシミュレーター</h1>
    
    <div class="start-date-box">
        <h4>全納品先で最も早い発注開始日:</h4>
        <h2>{{ global_start_date if global_start_date else '納品希望日を入力してください' }}</h2>
    </div>

    {% if all_schedules %}
    <div class="gantt-chart-container">
        <canvas id="ganttChart"></canvas>
    </div>
    {% endif %}

    <h2 class="text-center mt-5 mb-3">薬局納品スケジュールシミュレーター (複数納品先対応)</h2>
    
    <hr>
    
    <div class="card p-3 mb-4">
        <h4 class="mb-3">工程名の設定</h4>
        <p class="text-muted">ここで工程名を設定した後、「工程名を適用」ボタンを押してください。設定された工程名がすべての納品先グループに反映されます。</p>
        <div id="processNameContainer">
            {% for name in process_names_form %}
            <div class="input-group process-input-group">
                <input type="text" class="form-control process-name-input" 
                       name="process_name[]" value="{{ name }}" required>
                <button type="button" class="btn btn-danger remove-process-btn">削除</button>
            </div>
            {% endfor %}
            {% if not process_names_form %}
            {% set default_names = ['ピッキング', 'ピッキング監査', '一包化', '一包化監査', 'ホチキス・テープ止め', 'ホチキス・テープ止め監査', 'カレンダーセット', 'カレンダー監査'] %}
            {% for i in range(8) %}
                <div class="input-group process-input-group">
                    <input type="text" class="form-control process-name-input" 
                           name="process_name[]" value="{{ default_names[i] }}" required>
                    <button type="button" class="btn btn-danger remove-process-btn">削除</button>
                </div>
            {% endfor %}
            {% endif %}
        </div>
        <div class="mt-2">
            <button type="button" class="btn btn-success" id="addProcessBtn">工程を追加</button>
        </div>
    </div>

    <form method="POST" id="mainForm">
        
        <div id="deliveryContainer">
            {% for i in range(delivery_names_form|length) %}
            {% set delivery_name = delivery_names_form[i] %}
            {% set process_days_prefix = 'process_' %}
            
            <div class="delivery-box" data-delivery-index="{{ i }}">
                <div class="d-flex justify-content-between mb-3">
                    <h4>納品先 # {{ i + 1 }} :</h4>
                    <button type="button" class="btn btn-danger btn-sm remove-delivery-btn">削除</button>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">納品先名:</label>
                        <input type="text" class="form-control" name="delivery_name[]" value="{{ delivery_name }}" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">最終納品希望日:</label>
                        {% set delivery_date_key = 'delivery_date_' ~ i %}
                        <input type="date" class="form-control" name="{{ delivery_date_key }}" 
                               value="{{ request.form.get(delivery_date_key) }}" required>
                    </div>
                </div>

                <h5>工程スケジュール</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="width: 70%;">工程名</th>
                            <th style="width: 30%;">所要営業日数</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p_index in range(process_names_form|length) %}
                        <tr>
                            <td>{{ process_names_form[p_index] }}</td>
                            <td>
                                {% set days_key = process_days_prefix ~ p_index ~ '_days_' ~ i %}
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control process-days-input" 
                                           name="{{ days_key }}" 
                                           value="{{ process_days_form.get(days_key, '1') }}" 
                                           min="1" step="1" required>
                                    <span class="input-group-text">営業日</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
            
            {% if not delivery_names_form %}
            <div class="delivery-box" data-delivery-index="0">
                <div class="d-flex justify-content-between mb-3">
                    <h4>納品先 # 1 :</h4>
                    <button type="button" class="btn btn-danger btn-sm remove-delivery-btn">削除</button>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">納品先名:</label>
                        <input type="text" class="form-control" name="delivery_name[]" value="正徳円" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">最終納品希望日:</label>
                        <input type="date" class="form-control" name="delivery_date_0" required>
                    </div>
                </div>
                <h5>工程スケジュール</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="width: 70%;">工程名</th>
                            <th style="width: 30%;">所要営業日数</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set default_names = ['ピッキング', 'ピッキング監査', '一包化', '一包化監査', 'ホチキス・テープ止め', 'ホチキス・テープ止め監査', 'カレンダーセット', 'カレンダー監査'] %}
                        {% for p_index in range(8) %}
                        <tr>
                            <td>{{ default_names[p_index] }}</td>
                            <td>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control process-days-input" 
                                           name="process_{{ p_index }}_days_0" value="1" min="1" step="1" required>
                                    <span class="input-group-text">営業日</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>

        <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-success" id="addDeliveryBtn">納品先を追加</button>
            <button type="submit" class="btn btn-primary">スケジュールを逆算</button>
        </div>
    </form>
    
    <div class="start-date-box mt-5">
        <h4>全納品先で最も早い発注開始日:</h4>
        <h2>{{ global_start_date if global_start_date else '納品希望日を入力してください' }}</h2>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let deliveryIndex = {{ delivery_names_form|length if delivery_names_form else 1 }};

        // --- 納品先追加/削除機能 ---
        document.getElementById('addDeliveryBtn').addEventListener('click', function() {
            const deliveryContainer = document.getElementById('deliveryContainer');
            const newDeliveryIndex = deliveryContainer.children.length; 
            const processNames = Array.from(document.querySelectorAll('.process-name-input')).map(input => input.value);

            let newDeliveryHtml = `
            <div class="delivery-box" data-delivery-index="${newDeliveryIndex}">
                <div class="d-flex justify-content-between mb-3">
                    <h4>納品先 # ${newDeliveryIndex + 1} :</h4>
                    <button type="button" class="btn btn-danger btn-sm remove-delivery-btn">削除</button>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">納品先名:</label>
                        <input type="text" class="form-control" name="delivery_name[]" value="" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">最終納品希望日:</label>
                        <input type="date" class="form-control" name="delivery_date_${newDeliveryIndex}" required>
                    </div>
                </div>
                <h5>工程スケジュール</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="width: 70%;">工程名</th>
                            <th style="width: 30%;">所要営業日数</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            processNames.forEach((name, p_index) => {
                newDeliveryHtml += `
                    <tr>
                        <td>${name}</td>
                        <td>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control process-days-input" 
                                       name="process_${p_index}_days_${newDeliveryIndex}" value="1" min="1" step="1" required>
                                <span class="input-group-text">営業日</span>
                            </div>
                        </td>
                    </tr>
                `;
            });

            newDeliveryHtml += `
                    </tbody>
                </table>
            </div>
            `;
            
            deliveryContainer.insertAdjacentHTML('beforeend', newDeliveryHtml);
            deliveryIndex++;
            updateDeliveryIndexes();
        });

        // 削除ボタンのリスナー (イベントデリゲーションを使用)
        document.getElementById('deliveryContainer').addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-delivery-btn')) {
                const deliveryBox = e.target.closest('.delivery-box');
                if (deliveryBox && document.getElementById('deliveryContainer').children.length > 1) {
                    deliveryBox.remove();
                    updateDeliveryIndexes();
                } else {
                    alert("納品先は最低1つ必要です。");
                }
            }
        });

        // 納品先削除時のインデックス更新
        function updateDeliveryIndexes() {
            const boxes = document.querySelectorAll('.delivery-box');
            boxes.forEach((box, index) => {
                box.setAttribute('data-delivery-index', index);
                box.querySelector('h4').textContent = `納品先 # ${index + 1} :`;
                
                const deliveryDateInput = box.querySelector('input[name^="delivery_date_"]');
                if (deliveryDateInput) {
                    deliveryDateInput.name = `delivery_date_${index}`;
                }
                
                const processDaysInputs = box.querySelectorAll('input[name^="process_"]');
                processDaysInputs.forEach(input => {
                    const parts = input.name.split('_');
                    input.name = `process_${parts[1]}_days_${index}`;
                });
            });
            deliveryIndex = boxes.length;
        }

        // --- 工程名追加/削除機能 ---
        document.getElementById('addProcessBtn').addEventListener('click', function() {
            const container = document.getElementById('processNameContainer');
            const newProcessHtml = `
            <div class="input-group process-input-group">
                <input type="text" class="form-control process-name-input" 
                       name="process_name[]" value="" required>
                <button type="button" class="btn btn-danger remove-process-btn">削除</button>
            </div>
            `;
            container.insertAdjacentHTML('beforeend', newProcessHtml);
        });
        
        document.getElementById('processNameContainer').addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-process-btn')) {
                const inputGroup = e.target.closest('.input-group');
                if (inputGroup) {
                    inputGroup.remove();
                }
            }
        });

        // --- ガントチャート描画 ---
        function renderGanttChart() {
            const ctx = document.getElementById('ganttChart');
            if (!ctx) return;

            const schedules = JSON.parse('{{ all_schedules | tojson | safe }}');
            if (schedules.length === 0) return;

            const chartStartDate = dayjs('{{ gantt_fixed_start_date | default("2025-11-01") }}');
            let maxEndDate = dayjs(chartStartDate);

            const datasets = [];
            
            schedules.forEach(delivery => {
                const deliveryIndex = datasets.length;
                const baseLabel = delivery.delivery_name || `納品先 ${deliveryIndex + 1}`;
                
                // タスクバーのデータセットを構築するための準備
                const taskBarData = [];
                
                // タスクデータの準備
                delivery.schedule.forEach(task => {
                    const start = dayjs(task.start);
                    const end = dayjs(task.end);
                    
                    taskBarData.push({ 
                        x: start.valueOf(), 
                        y: deliveryIndex, 
                        x2: end.add(1, 'day').valueOf(), 
                        label: task.name, 
                        backgroundColor: getTaskColor(task.name)
                    });

                    if (end.isAfter(maxEndDate)) {
                        maxEndDate = end;
                    }
                });
                
                // --- ★ 修正ポイント: タスクバーを個別のデータセットとして追加 ---
                taskBarData.forEach(taskData => {
                    datasets.push({
                        label: `${baseLabel}: ${taskData.label}`, 
                        data: [{
                            x: taskData.x,
                            y: taskData.y,
                            x2: taskData.x2,
                        }],
                        backgroundColor: taskData.backgroundColor,
                        borderColor: taskData.backgroundColor,
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false,
                        stack: taskData.y, // 同じ納品先は同じスタック
                        categoryPercentage: 0.8, // タスクバーの太さ
                        barPercentage: 0.8,
                    });
                });
                
                // --- 納品日マーカー ---
                const deliveryDate = dayjs(delivery.delivery_date);
                datasets.push({
                    label: `${baseLabel}: 納品`,
                    data: [{ 
                        x: deliveryDate.valueOf(), 
                        y: deliveryIndex, 
                        x2: deliveryDate.add(1, 'day').valueOf(),
                        backgroundColor: 'red'
                    }],
                    type: 'bar',
                    barPercentage: 0.1, // マーカーを細く
                    categoryPercentage: 0.1,
                    stack: deliveryIndex,
                });

                // --- 全体発注STARTマーカー ---
                const startDate = dayjs(delivery.start_date);
                 datasets.push({
                    label: `${baseLabel}: START`,
                    data: [{ 
                        x: startDate.valueOf(), 
                        y: deliveryIndex, 
                        x2: startDate.add(1, 'day').valueOf(),
                        backgroundColor: 'green'
                    }],
                    type: 'bar',
                    barPercentage: 0.1, // マーカーを細く
                    categoryPercentage: 0.1,
                    stack: deliveryIndex,
                });
            });

            // Y軸ラベルの準備
            const deliveryLabels = schedules.map(d => d.delivery_name);

            // Chart.jsの設定
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: deliveryLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', 
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'YYYY/MM/DD',
                                displayFormats: {
                                    day: 'M/D(ddd)'
                                }
                            },
                            min: chartStartDate.valueOf(),
                            max: maxEndDate.add(7, 'day').valueOf(), 
                            title: {
                                display: true,
                                text: '日付'
                            },
                            ticks: {
                                source: 'data',
                                autoSkip: false,
                                maxRotation: 0,
                                minRotation: 0,
                            }
                        },
                        y: {
                            labels: deliveryLabels,
                            stacked: true,
                            title: {
                                display: true,
                                text: '納品先'
                            },
                            reverse: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const start = dayjs(context.parsed._custom.barStart).format('YYYY/MM/DD');
                                    const end = dayjs(context.parsed._custom.barEnd).subtract(1, 'day').format('YYYY/MM/DD');
                                    return `${label}: ${start} - ${end}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- タスクカラー設定 ---
        function getTaskColor(taskName) {
            let hash = 0;
            for (let i = 0; i < taskName.length; i++) {
                hash = taskName.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }

        if (document.getElementById('ganttChart')) {
            renderGanttChart();
        }

    });
</script>

</body>
</html>