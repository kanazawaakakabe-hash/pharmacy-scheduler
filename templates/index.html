<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–¬å±€ç´å“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ (ãƒãƒ«ãƒ)</title>
    
    <style>
        /* CSSå¤‰æ•°ã§è‰²ã‚’å®šç¾© */
        :root {
            --color-picking: #007bff;          /* ãƒ”ãƒƒã‚­ãƒ³ã‚° */
            --color-picking-audit: #5bc0de;    /* ãƒ”ãƒƒã‚­ãƒ³ã‚°ç›£æŸ» */
            --color-ippoka: #28a745;           /* ä¸€åŒ…åŒ– */
            --color-ippoka-audit: #6c757d;     /* ä¸€åŒ…åŒ–ç›£æŸ» */
            --color-staple: #ffc107;           /* ãƒ›ãƒã‚­ã‚¹ãƒ»ãƒ†ãƒ¼ãƒ—æ­¢ã‚ */
            --color-staple-audit: #fd7e14;     /* ãƒ›ãƒã‚­ã‚¹ãƒ»ãƒ†ãƒ¼ãƒ—æ­¢ã‚ç›£æŸ» */
            --color-calendar: #e83e8c;         /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ãƒƒãƒˆ */
            --color-calendar-audit: #6f42c1;   /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç›£æŸ» */
            --color-default-process: #343a40;  /* ãã®ä»–/æœªè¨­å®š */
        }

        /* --- å·¥ç¨‹ã”ã¨ã®è‰²åˆ†ã‘ã‚¯ãƒ©ã‚¹ (ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆç”¨) --- */
        .process-picking { background-color: var(--color-picking); }
        .process-picking-audit { background-color: var(--color-picking-audit); }
        .process-ippoka { background-color: var(--color-ippoka); }
        .process-ippoka-audit { background-color: var(--color-ippoka-audit); }
        .process-staple { background-color: var(--color-staple); }
        .process-staple-audit { background-color: var(--color-staple-audit); }
        .process-calendar { background-color: var(--color-calendar); }
        .process-calendar-audit { background-color: var(--color-calendar-audit); }
        .process-default { background-color: var(--color-default-process); }


        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f9; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 3px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="date"], input[type="number"], input[type="text"] { padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .result { margin-top: 30px; padding: 15px; border: 2px solid #28a745; background-color: #e6ffed; border-radius: 5px; text-align: center; }
        .result h2 { color: #28a745; margin-top: 0; }
        .result p { font-size: 1.5em; font-weight: bold; }

        /* --- å·¥ç¨‹åè¨­å®šã‚¨ãƒªã‚¢ --- */
        #process-setting-area { border: 2px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px; background-color: #fffbe6; }
        #process-list { list-style: none; padding: 0; }
        .process-item { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
        .process-item input[type="text"] { flex-grow: 1; border: 1px solid #ffc107; }
        .process-item button { background-color: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.9em; }
        #add-process-btn { background-color: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        #apply-process-btn { background-color: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px; }
        
        /* --- 1. è¨­å®šä¿å­˜ãƒ»å°åˆ·ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ --- */
        #utility-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        #utility-buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        #save-config-btn { background-color: #17a2b8; color: white; }
        #load-config-btn { background-color: #ffc107; color: #333; }
        #print-gantt-btn { background-color: #6c757d; color: white; } 


        /* --- å·¥ç¨‹ãƒ»ç´å“å…ˆå…¥åŠ›ã‚¨ãƒªã‚¢ --- */
        .delivery-group-container { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .delivery-group { border: 1px solid #007bff; padding: 15px; border-radius: 4pt; flex: 1 1 300px; position: relative; }
        .delivery-group h2 { font-size: 1.2em; margin-top: 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #007bff; padding-bottom: 5px; }
        .delivery-group .remove-btn { background-color: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.9em; }
        
        /* --- å·¥ç¨‹æ—¥æ•°å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ« --- */
        .process-days-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .process-days-table th, .process-days-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .process-days-table th { background-color: #f2f2f2; font-weight: normal; width: 50%; }
        .process-days-table input[type="number"] { width: 60px; text-align: center; }

        /* --- ãƒœã‚¿ãƒ³ --- */
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .action-buttons button { flex: 1; padding: 10px; font-size: 16px; }
        #add-delivery-btn { background-color: #28a745; }
        #add-delivery-btn:hover { background-color: #1e7e34; }
        
        /* --- 2é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆï¼‰ --- */
        #gantt-chart-simple { margin-top: 40px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .calendar-chart-wrapper { display: flex; flex-direction: column; min-width: 1000px; }
        
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ—¥ä»˜ã¨æ›œæ—¥ï¼‰ */
        .calendar-header, .chart-row-cal { display: flex; flex-shrink: 0; }
        .delivery-label-col { width: 180px; flex-shrink: 0; font-weight: bold; padding: 5px; border-right: 1px solid #ccc; background-color: #e0f0ff; } 
        .date-cell, .day-cell, .task-cell { flex: 1 0 auto; width: 40px; text-align: center; border-left: 1px solid #eee; padding: 5px 0; }
        .calendar-header { border-bottom: 2px solid #ccc; margin-bottom: 5px; }
        .date-cell { font-size: 0.8em; background-color: #f9f9f9; border-bottom: 1px solid #ccc; }
        .day-cell { font-size: 0.7em; background-color: #eee; }
        .day-cell.sat { color: #007bff; }
        .day-cell.sun { color: #dc3545; }

        /* ã‚¿ã‚¹ã‚¯è¡Œ */
        .chart-row-cal { align-items: center; border-bottom: 1px dashed #eee; }
        .chart-row-cal:last-child { border-bottom: none; }
        .task-cell { position: relative; height: 35px; } /* æŠ˜ã‚Šè¿”ã—ã®ãŸã‚é«˜ã•ã‚’ç¢ºä¿ */
        
        /* --- ã‚¿ã‚¹ã‚¯ãƒãƒ¼ï¼ˆå·¥ç¨‹ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ --- */
        .task-bar-cal { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            margin: 3px 0; 
            border-radius: 2px; 
            opacity: 0.9; 
            font-size: 0.7em; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            
            /* ã€æ–‡å­—ã®æŠ˜ã‚Šè¿”ã—ã¨è¡¨ç¤ºã‚’æ”¹å–„ã€‘ */
            overflow: visible; 
            white-space: normal; /* æŠ˜ã‚Šè¿”ã—ã‚’æœ‰åŠ¹åŒ– */
            word-break: break-all; /* é•·ã„å˜èªã§ã‚‚å¼·åˆ¶çš„ã«æ”¹è¡Œ */
            line-height: 1.1; /* è¡Œé–“ã‚’è©°ã‚ã‚‹ */
            padding: 0 1px; 
            text-align: center;
            /* èƒŒæ™¯è‰²ã‚’å°åˆ·ã§ã‚‚å¼·åˆ¶çš„ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®é‡è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ */
            -webkit-print-color-adjust: exact;
            color-adjust: exact; 
        }

        .delivery-mark { background-color: #dc3545; width: 80%; margin: auto; height: 80%; border-radius: 50%; font-size: 0.7em; display: flex; align-items: center; justify-content: center; opacity: 1; }
        .order-start-mark { background-color: #28a745; color: white; font-weight: bold; position: absolute; top: 0; bottom: 0; left: 0; right: 0; margin: 3px; border-radius: 2px; font-size: 0.7em; display: flex; align-items: center; justify-content: center; }
        
        /* ç´å“å…ˆåè¡¨ç¤º */
        .delivery-name-row { background-color: #f0f8ff; font-weight: bold; padding: 5px; border-top: 2px solid #007bff; }
        .delivery-start-date { font-size: 0.9em; font-weight: normal; color: #555; }
        
        /* --- 2. å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (A4æ¨ªå‘ãã«æœ€é©åŒ–) --- */
        @media print {
            body * { visibility: hidden; } /* å…¨ã¦éè¡¨ç¤ºã« */
            .container { max-width: none; margin: 0; padding: 0; box-shadow: none; }
            
            /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã¨ãƒ˜ãƒƒãƒ€ãƒ¼ã€å…¨ä½“ç™ºæ³¨é–‹å§‹æ—¥ã®ã¿è¡¨ç¤º */
            #gantt-chart-print-area, #gantt-chart-print-area * { visibility: visible; }
            #gantt-chart-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 10mm; /* å°åˆ·æ™‚ã®ä½™ç™½ */
                box-sizing: border-box;
            }
            
            /* A4æ¨ªå‘ã */
            @page {
                size: A4 landscape;
                margin: 10mm;
            }
            
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¨çµæœè¡¨ç¤ºã‚‚å°åˆ·ã‚¨ãƒªã‚¢ã«å«ã‚ã‚‹ */
            .print-header { visibility: visible; margin-bottom: 20px; }
            .print-header h1 { visibility: visible; text-align: left; border-bottom: 1px solid #333; }
            .print-header .result { visibility: visible; border: none; background: none; text-align: left; padding: 0; }
            .print-header .result p { font-size: 1.2em; }

            .calendar-chart-wrapper { min-width: 100%; }
            .delivery-label-col { width: 150px; } /* å°åˆ·æ™‚ã¯å°‘ã—å¹…ã‚’æ¸›ã‚‰ã™ */
            .date-cell, .day-cell, .task-cell { width: 35px; } /* å°åˆ·æ™‚ã¯ã‚»ãƒ«ã‚’ç‹­ã */

            /* å°åˆ·æ™‚ã®æŠ˜ã‚Šè¿”ã—è¨­å®š */
            .task-bar-cal {
                white-space: normal;
                word-break: break-all;
                line-height: 1.1;
                padding: 0 1px;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <div id="gantt-chart-print-area">
            <div class="print-header">
                <h1>è–¬å±€ç´å“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
                {% if global_start_date %}
                    <div class="result">
                        <h2>å…¨ç´å“å…ˆã§æœ€ã‚‚æ—©ã„ç™ºæ³¨é–‹å§‹æ—¥:</h2>
                        <p>{{ global_start_date }}</p>
                    </div>
                {% endif %}
            </div>
            <div id="gantt-chart-simple"></div>
        </div>


        <h1>è–¬å±€ç´å“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ (è¤‡æ•°ç´å“å…ˆå¯¾å¿œ)</h1>
        
        <div id="utility-buttons">
            <button type="button" id="save-config-btn">âš™ï¸ è¨­å®šã‚’ä¿å­˜</button>
            <button type="button" id="load-config-btn">ğŸ“¥ è¨­å®šã‚’èª­è¾¼</button>
            <button type="button" id="print-gantt-btn">ğŸ–¨ï¸ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å°åˆ·</button>
        </div>
        
        <div id="process-setting-area">
            <h2>å·¥ç¨‹åã®è¨­å®š</h2>
            <p>â€»ã“ã“ã§å·¥ç¨‹åã‚’è¨­å®šã—ãŸå¾Œã€ã€Œå·¥ç¨‹åã‚’é©ç”¨ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚è¨­å®šã•ã‚ŒãŸå·¥ç¨‹åãŒã™ã¹ã¦ã®ç´å“å…ˆã‚°ãƒ«ãƒ¼ãƒ—ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
            <ul id="process-list">
                </ul>
            <button type="button" id="add-process-btn">å·¥ç¨‹ã‚’è¿½åŠ </button>
            <button type="button" id="apply-process-btn">å·¥ç¨‹åã‚’é©ç”¨</button>
        </div>
        
        <form method="POST" id="schedule-form">
            <div id="hidden-process-names">
                {# Flaskã‹ã‚‰æ¸¡ã•ã‚ŒãŸå·¥ç¨‹åã‚’Jinjaã§æŒ¿å…¥ #}
                {% set effective_process_names = process_names_form %}
                
                {% for name in effective_process_names %}
                    <input type="hidden" name="process_name[]" value="{{ name }}">
                {% endfor %}
            </div>


            <div class="delivery-group-container" id="delivery-group-container">
                {# ç´å“å…ˆã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° #}
                {% for d_index in range(delivery_names_form|length) %}
                <div class="delivery-group" data-delivery-index="{{ d_index }}">
                    <h2>
                        ç´å“å…ˆ #<span class="delivery-index-label">{{ d_index + 1 }}</span>:
                        <button type="button" class="remove-btn" onclick="removeDeliveryGroup(this)">å‰Šé™¤</button>
                    </h2>
                    
                    <label>ç´å“å…ˆå:</label>
                    <input type="text" name="delivery_name[]" value="{{ delivery_names_form[d_index] }}" required>
                    
                    <label>æœ€çµ‚ç´å“å¸Œæœ›æ—¥:</label>
                    <input type="date" name="delivery_date_{{ d_index }}" required value="{{ request.form['delivery_date_' + d_index|string] or '' }}">

                    <table class="process-days-table">
                        <thead>
                            <tr>
                                <th>å·¥ç¨‹å</th>
                                <th>æ‰€è¦å–¶æ¥­æ—¥æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for process_name in effective_process_names %}
                            {% set p_index = loop.index0 %}
                            <tr>
                                <td><input type="text" value="{{ process_name }}" readonly style="border:none; background:transparent;" class="process-name-display"></td>
                                <td>
                                    {% set days_key = 'process_' + p_index|string + '_days_' + d_index|string %}
                                    <input type="number" name="{{ days_key }}" min="0" value="{{ process_days_form[days_key] or '1' }}" required> å–¶æ¥­æ—¥
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endfor %}
            </div>
            
            <div class="action-buttons">
                <button type="button" id="add-delivery-btn">ç´å“å…ˆã‚’è¿½åŠ </button>
                <button type="submit">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é€†ç®—</button>
            </div>
        </form>

        {% if global_start_date %}
            <div class="result">
                <h2>å…¨ç´å“å…ˆã§æœ€ã‚‚æ—©ã„ç™ºæ³¨é–‹å§‹æ—¥:</h2>
                <p>{{ global_start_date }}</p>
            </div>
        {% endif %}
    </div>

    <script>
        // --- Jinjaã‹ã‚‰å›ºå®šé–‹å§‹æ—¥ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— ---
        const GANTT_FIXED_START_DATE = "{{ gantt_fixed_start_date }}";
        const allSchedules = {{ all_schedules | tojson | safe }} || []; 

        // --- åˆæœŸè¨­å®šã•ã‚ŒãŸæ–°ã—ã„å·¥ç¨‹åãƒªã‚¹ãƒˆ (app.pyã¨ä¸€è‡´) ---
        const DEFAULT_PROCESS_NAMES = [
            'ãƒ”ãƒƒã‚­ãƒ³ã‚°',
            'ãƒ”ãƒƒã‚­ãƒ³ã‚°ç›£æŸ»',
            'ä¸€åŒ…åŒ–',
            'ä¸€åŒ…åŒ–ç›£æŸ»',
            'ãƒ›ãƒã‚­ã‚¹ãƒ»ãƒ†ãƒ¼ãƒ—æ­¢ã‚',
            'ãƒ›ãƒã‚­ã‚¹ãƒ»ãƒ†ãƒ¼ãƒ—æ­¢ã‚ç›£æŸ»',
            'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ãƒƒãƒˆ',
            'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç›£æŸ»'
        ];
        
        // Jinjaã§æŒ¿å…¥ã•ã‚ŒãŸéš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å·¥ç¨‹åã‚’å–å¾—
        let currentProcessNames = [];
        document.querySelectorAll('#hidden-process-names input[name="process_name[]"]').forEach(input => {
            const name = input.value.trim();
            if (name) {
                currentProcessNames.push(name);
            }
        });
        
        // å¿µã®ãŸã‚ã€åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«currentProcessNamesãŒç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’é©ç”¨
        if (currentProcessNames.length === 0 || (currentProcessNames.length === 1 && currentProcessNames[0] === '')) {
             currentProcessNames = DEFAULT_PROCESS_NAMES;
        }

        const processListElement = document.getElementById('process-list');
        const deliveryContainer = document.getElementById('delivery-group-container');
        const hiddenProcessNamesDiv = document.getElementById('hidden-process-names');
        const scheduleForm = document.getElementById('schedule-form');

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
        function parseDate(dateStr) {
            const parts = dateStr.split('-');
            return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
        }
        
        function formatDate(dateObj) {
            const y = dateObj.getUTCFullYear();
            const m = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getUTCDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        function getDayName(dayIndex) {
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            return days[dayIndex];
        }

        // --- ğŸ¨ å·¥ç¨‹åã«å¿œã˜ãŸCSSã‚¯ãƒ©ã‚¹åã‚’æ±ºå®šã™ã‚‹é–¢æ•° ---
        function getProcessClass(processName) {
            const normalizedName = processName.trim();
            switch (normalizedName) {
                case 'ãƒ”ãƒƒã‚­ãƒ³ã‚°': return 'process-picking';
                case 'ãƒ”ãƒƒã‚­ãƒ³ã‚°ç›£æŸ»': return 'process-picking-audit';
                case 'ä¸€åŒ…åŒ–': return 'process-ippoka';
                case 'ä¸€åŒ…åŒ–ç›£æŸ»': return 'process-ippoka-audit';
                case 'ãƒ›ãƒã‚­ã‚¹ãƒ»ãƒ†ãƒ¼ãƒ—æ­¢ã‚': return 'process-staple';
                case 'ãƒ›ãƒã‚­ã‚¹ãƒ»ãƒ†ãƒ¼ãƒ—æ­¢ã‚ç›£æŸ»': return 'process-staple-audit';
                case 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ãƒƒãƒˆ': return 'process-calendar';
                case 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç›£æŸ»': return 'process-calendar-audit';
                default: return 'process-default'; 
            }
        }


        // --- 1. è¨­å®šä¿å­˜/èª­è¾¼ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        const LOCAL_STORAGE_KEY = 'pharmacy_schedule_config';

        function saveConfig() {
            updateProcessNamesFromInputs(); // ç¾åœ¨ã®å·¥ç¨‹è¨­å®šãƒªã‚¹ãƒˆã‚’æ›´æ–°

            const config = {
                processNames: currentProcessNames.filter(name => name !== ""),
                deliveryGroups: []
            };

            Array.from(deliveryContainer.children).forEach(group => {
                const d_index = parseInt(group.getAttribute('data-delivery-index'));
                const deliveryName = group.querySelector('input[name="delivery_name[]"]').value;
                const deliveryDate = group.querySelector(`input[name="delivery_date_${d_index}"]`).value;
                
                const processDays = {};
                group.querySelectorAll('.process-days-table tbody tr').forEach(row => {
                    const nameInput = row.querySelector('.process-name-display');
                    const daysInput = row.querySelector('input[type="number"]');
                    if (nameInput && daysInput) {
                        processDays[nameInput.value] = daysInput.value;
                    }
                });
                
                config.deliveryGroups.push({
                    deliveryName,
                    deliveryDate,
                    processDays
                });
            });

            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(config));
                alert('âœ… è¨­å®šã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸã€‚');
            } catch (e) {
                alert('âŒ è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        function loadConfig() {
            const savedConfig = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!savedConfig) {
                alert('ğŸš¨ ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            if (!confirm('ç¾åœ¨ã®å…¥åŠ›å†…å®¹ã‚’ç ´æ£„ã—ã¦ã€ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const config = JSON.parse(savedConfig);
                
                // 1. å·¥ç¨‹åãƒªã‚¹ãƒˆã®æ›´æ–°
                currentProcessNames = config.processNames || DEFAULT_PROCESS_NAMES;
                renderProcessSettingList(); 
                applyProcessNamesToDeliveryGroups(null); // ç´å“å…ˆã‚°ãƒ«ãƒ¼ãƒ—ã®å·¥ç¨‹åã‚‚æ›´æ–°

                // 2. ç´å“å…ˆã‚°ãƒ«ãƒ¼ãƒ—ã‚’ã‚¯ãƒªã‚¢ã—ã€å†æ§‹ç¯‰
                deliveryContainer.innerHTML = '';
                (config.deliveryGroups || []).forEach((groupData, d_index) => {
                    const newGroup = addDeliveryGroup(d_index, { 
                        deliveryName: groupData.deliveryName,
                        deliveryDate: groupData.deliveryDate
                    });
                    
                    // æ—¥æ•°ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
                    if (newGroup) {
                        newGroup.querySelectorAll('.process-days-table tbody tr').forEach(row => {
                            const nameInput = row.querySelector('.process-name-display');
                            const daysInput = row.querySelector('input[type="number"]');
                            if (nameInput && daysInput && groupData.processDays[nameInput.value]) {
                                daysInput.value = groupData.processDays[nameInput.value];
                            }
                        });
                    }
                });
                
                updateDeliveryLabels();
                alert('ğŸ‘ è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é€†ç®—ã—ç›´ã—ã¦ãã ã•ã„ã€‚');

            } catch (e) {
                alert('âŒ è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
            }
        }

        // --- å°åˆ·ãƒ­ã‚¸ãƒƒã‚¯ ---
        function printGantt() {
            window.print();
        }

        // --- 2. å·¥ç¨‹åè¨­å®šã‚¨ãƒªã‚¢ã®æ“ä½œ ---

        function renderProcessSettingList() {
            processListElement.innerHTML = '';
            
            if (currentProcessNames.length === 0) {
                 processListElement.innerHTML = '<li>ç¾åœ¨ã€å·¥ç¨‹ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</li>';
                 return;
            }

            currentProcessNames.forEach((name, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'process-item';
                listItem.innerHTML = `
                    <input type="text" value="${name}" data-index="${index}" placeholder="å·¥ç¨‹åã‚’å…¥åŠ›" required>
                    <button type="button" onclick="removeProcessSetting(${index})">å‰Šé™¤</button>
                `;
                processListElement.appendChild(listItem);
            });
        }

        function addProcessSetting() {
            currentProcessNames.push("");
            renderProcessSettingList();

            const newInputs = processListElement.querySelectorAll('.process-item input[type="text"]');
            if (newInputs.length > 0) {
                newInputs[newInputs.length - 1].focus();
            }
        }

        function removeProcessSetting(index) {
            updateProcessNamesFromInputs(); 
            if (confirm(`ã€Œ${currentProcessNames[index] || 'æ–°ã—ã„å·¥ç¨‹'}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                currentProcessNames.splice(index, 1);
                renderProcessSettingList();
                // å‰Šé™¤å¾Œã‚‚å³åº§ã«åæ˜ ã•ã›ã‚‹
                applyProcessNamesToDeliveryGroups(null); 
            }
        }

        function updateProcessNamesFromInputs() {
            const inputs = processListElement.querySelectorAll('.process-item input[type="text"]');
            currentProcessNames = Array.from(inputs).map(input => input.value.trim());
        }
        
        // --- 3. å·¥ç¨‹åã‚’ç´å“å…ˆã‚°ãƒ«ãƒ¼ãƒ—ã«åæ˜ ã•ã›ã‚‹ ---
        
        function applyProcessNamesToDeliveryGroups(event) {
            // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼‰ã¯ã€å…¥åŠ›æ¬„ã‹ã‚‰æœ€æ–°ã®å·¥ç¨‹åã‚’å–å¾—
            if (event && event.type === 'click') {
                updateProcessNamesFromInputs();
            }
            
            const validProcessNames = currentProcessNames.filter(name => name !== "");
            
            if (validProcessNames.length === 0) {
                if (event && event.type === 'click') {
                    alert("å·¥ç¨‹åãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å°‘ãªãã¨ã‚‚ä¸€ã¤å·¥ç¨‹ã‚’è¿½åŠ ãƒ»è¨­å®šã—ã¦ãã ã•ã„ã€‚");
                }
                return;
            }
            
            // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ›´æ–° (ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ãƒ‡ãƒ¼ã‚¿)
            hiddenProcessNamesDiv.innerHTML = validProcessNames.map(name => 
                `<input type="hidden" name="process_name[]" value="${name}">`
            ).join('');

            // å„ç´å“å…ˆã‚°ãƒ«ãƒ¼ãƒ—ã®å·¥ç¨‹æ—¥æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æ§‹ç¯‰
            Array.from(deliveryContainer.children).forEach(group => {
                const d_index = parseInt(group.getAttribute('data-delivery-index'));
                const tableBody = group.querySelector('.process-days-table tbody');
                
                // æ—¢å­˜ã®æ—¥æ•°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ (ã‚­ãƒ¼: æ—§å·¥ç¨‹å => æ—¥æ•°)
                const existingDays = {};
                group.querySelectorAll('.process-days-table tbody tr').forEach(row => {
                    const nameInput = row.querySelector('.process-name-display');
                    const daysInput = row.querySelector('input[type="number"]');
                    if (nameInput && daysInput) {
                        existingDays[nameInput.value] = daysInput.value;
                    }
                });

                tableBody.innerHTML = ''; // ãƒ†ãƒ¼ãƒ–ãƒ«å†…å®¹ã‚’ã‚¯ãƒªã‚¢

                validProcessNames.forEach((name, p_index) => {
                    const days_key = `process_${p_index}_days_${d_index}`;
                    // æ–°ã—ã„å·¥ç¨‹åã«å¯¾å¿œã™ã‚‹æ—¥æ•°ã‚’ã€æ—§å·¥ç¨‹åã®æ—¥æ•°ã‹ã‚‰å–å¾—ã€‚ãªã‘ã‚Œã° '1'
                    const defaultValue = existingDays[name] || '1'; 
                    
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" value="${name}" readonly style="border:none; background:transparent;" class="process-name-display"></td>
                        <td>
                            <input type="number" name="${days_key}" min="0" value="${defaultValue}" required> å–¶æ¥­æ—¥
                        </td>
                    `;
                    tableBody.appendChild(newRow);
                });
            });
            
            currentProcessNames = validProcessNames;
            renderProcessSettingList();
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«ã‚ˆã‚‹é©ç”¨æ™‚ã®ã¿ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™
            if (event && event.type === 'click') {
                alert(`å·¥ç¨‹å (${validProcessNames.length}å€‹) ãŒã™ã¹ã¦ã®ç´å“å…ˆã‚°ãƒ«ãƒ¼ãƒ—ã«é©ç”¨ã•ã‚Œã¾ã—ãŸã€‚`);
            }
        }


        // --- 4. ç´å“å…ˆã‚°ãƒ«ãƒ¼ãƒ—ã®æ“ä½œ ---

        function addDeliveryGroup(d_index, initialData = {}) {
            const validProcessNames = currentProcessNames.filter(name => name !== "");
            
            if (validProcessNames.length === 0) {
                 alert("å…ˆã«ã€Œå·¥ç¨‹åè¨­å®šã‚¨ãƒªã‚¢ã€ã§å·¥ç¨‹åã‚’è¨­å®šã—ã€ã€Œå·¥ç¨‹åã‚’é©ç”¨ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
                 return null;
            }

            const newGroup = document.createElement('div');
            newGroup.className = 'delivery-group';
            newGroup.setAttribute('data-delivery-index', d_index);

            const defaultDeliveryName = initialData.deliveryName || `ç´å“å…ˆ${d_index + 1}`;
            const defaultDeliveryDate = initialData.deliveryDate || '';

            let tableRows = '';
            
            validProcessNames.forEach((name, p_index) => {
                const days_key = `process_${p_index}_days_${d_index}`;
                // èª­è¾¼æ™‚ã¯åˆæœŸãƒ‡ãƒ¼ã‚¿ã®æ—¥æ•°ã€ãã‚Œä»¥å¤–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®'1'
                const daysValue = (initialData.processDays && initialData.processDays[name]) || '1';
                
                tableRows += `
                    <tr>
                        <td><input type="text" value="${name}" readonly style="border:none; background:transparent;" class="process-name-display"></td>
                        <td>
                            <input type="number" name="${days_key}" min="0" value="${daysValue}" required> å–¶æ¥­æ—¥
                        </td>
                    </tr>
                `;
            });

            newGroup.innerHTML = `
                <h2>
                    ç´å“å…ˆ #<span class="delivery-index-label">${d_index + 1}</span>:
                    <button type="button" class="remove-btn" onclick="removeDeliveryGroup(this)">å‰Šé™¤</button>
                </h2>
                <label>ç´å“å…ˆå:</label>
                <input type="text" name="delivery_name[]" value="${defaultDeliveryName}" required>
                
                <label>æœ€çµ‚ç´å“å¸Œæœ›æ—¥:</label>
                <input type="date" name="delivery_date_${d_index}" required value="${defaultDeliveryDate}">

                <table class="process-days-table">
                    <thead>
                        <tr><th>å·¥ç¨‹å</th><th>æ‰€è¦å–¶æ¥­æ—¥æ•°</th></tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            `;
            deliveryContainer.appendChild(newGroup);
            updateDeliveryLabels();
            return newGroup;
        }
        
        function removeDeliveryGroup(button) {
            button.closest('.delivery-group').remove();
            updateDeliveryLabels();
        }

        // ç´å“å…ˆã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨nameå±æ€§ã‚’ä¿®æ­£ã™ã‚‹
        function updateDeliveryLabels() {
            Array.from(deliveryContainer.children).forEach((group, index) => {
                group.setAttribute('data-delivery-index', index);
                
                // ç´å“å…ˆç•ªå·ãƒ©ãƒ™ãƒ«ã®æ›´æ–°
                const labelElement = group.querySelector('.delivery-index-label');
                if (labelElement) {
                    labelElement.textContent = index + 1;
                }
                
                // nameå±æ€§ã®æ›´æ–°
                group.querySelectorAll('[name^="delivery_date_"]').forEach(input => {
                    input.name = `delivery_date_${index}`;
                });
                group.querySelectorAll('[name^="process_"]').forEach(input => {
                    const parts = input.name.split('_');
                    if (parts.length >= 3) {
                         // parts[1]ã¯å·¥ç¨‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                         input.name = `process_${parts[1]}_days_${index}`; 
                    }
                });
            });
        }
        
        // --- 5. ç´å“å…ˆè»¸ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» (è‰²åˆ†ã‘ã«å¯¾å¿œ) â˜…â˜…â˜… å›ºå®šé–‹å§‹æ—¥ã‚’ä½¿ç”¨ â˜…â˜…â˜…
        
        function drawCalendarGantt() {
            const globalStartDateStr = "{{ global_start_date }}";
            const chartContainer = document.getElementById('gantt-chart-simple');
            
            // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã‹ã€ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒãªã„å ´åˆã¯å‡¦ç†ã—ãªã„
            if (allSchedules.length === 0 || !chartContainer) return;
            
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸå›ºå®šé–‹å§‹æ—¥ã‚’ä½¿ç”¨
            const fixedStartDateStr = GANTT_FIXED_START_DATE; 
            const fixedStartDate = parseDate(fixedStartDateStr); 
            
            chartContainer.innerHTML = ''; 
            const wrapper = document.createElement('div');
            wrapper.className = 'calendar-chart-wrapper';
            
            const daysToShow = 14;
            let currentDay = new Date(fixedStartDate); // å›ºå®šé–‹å§‹æ—¥ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ

            currentDay.setUTCHours(0, 0, 0, 0); 
            
            const headerDateRow = document.createElement('div');
            headerDateRow.className = 'calendar-header';
            headerDateRow.innerHTML = '<div class="delivery-label-col">ç´å“å…ˆ</div>';

            const headerDayRow = document.createElement('div');
            headerDayRow.className = 'calendar-header';
            headerDayRow.innerHTML = '<div class="delivery-label-col delivery-start-date">ãƒãƒ£ãƒ¼ãƒˆé–‹å§‹æ—¥: ' + fixedStartDateStr + '</div>';

            const dateList = []; 

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç”Ÿæˆ
            for (let i = 0; i < daysToShow; i++) {
                const dayName = getDayName(currentDay.getUTCDay());
                const dayClass = currentDay.getUTCDay() === 6 ? 'sat' : (currentDay.getUTCDay() === 0 ? 'sun' : '');

                headerDateRow.innerHTML += `<div class="date-cell">${currentDay.getUTCMonth() + 1}/${currentDay.getUTCDate()}</div>`;
                headerDayRow.innerHTML += `<div class="day-cell ${dayClass}">${dayName}</div>`;
                
                dateList.push(formatDate(currentDay));
                
                currentDay = new Date(currentDay.getTime() + (24 * 60 * 60 * 1000));
            }
            
            wrapper.appendChild(headerDayRow);
            wrapper.appendChild(headerDateRow);

            // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡Œã®æç”»
            allSchedules.forEach(delivery => {
                const dRow = document.createElement('div');
                dRow.className = 'chart-row-cal';
                
                const labelCol = document.createElement('div');
                labelCol.className = 'delivery-label-col';
                labelCol.textContent = delivery.delivery_name;
                dRow.appendChild(labelCol);
                
                dateList.forEach(dateStr => {
                    const cell = document.createElement('div');
                    cell.className = 'task-cell';
                    cell.setAttribute('data-date', dateStr);
                    
                    const currentDate = parseDate(dateStr);

                    delivery.schedule.forEach(p => {
                        const taskStart = parseDate(p.start);
                        // ç´å“æ—¥ï¼ˆçµ‚äº†æ—¥ï¼‰ã®1æ—¥å‰ã¾ã§ãŒå·¥ç¨‹æœŸé–“
                        const actualEndDate = new Date(parseDate(p.end).getTime() - (24 * 60 * 60 * 1000)); 
                        
                        if (currentDate >= taskStart && currentDate <= actualEndDate) {
                            const bar = document.createElement('div');
                            bar.className = 'task-bar-cal ' + getProcessClass(p.name);
                            
                            // ä¿®æ­£ç®‡æ‰€: æ–‡å­—ã®çœç•¥ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã€å¸¸ã«å·¥ç¨‹åã‚’è¡¨ç¤º
                            bar.textContent = p.name;
                            
                            cell.appendChild(bar);
                        }
                    });

                    const deliveryDate = parseDate(delivery.delivery_date);
                    if (formatDate(currentDate) === formatDate(deliveryDate)) {
                        const mark = document.createElement('div');
                        mark.className = 'delivery-mark';
                        mark.textContent = 'ç´å“';
                        cell.appendChild(mark);
                    }
                    
                    dRow.appendChild(cell);
                });
                wrapper.appendChild(dRow);
            });
            
            // å…¨ä½“ç™ºæ³¨é–‹å§‹æ—¥ã®ãƒãƒ¼ã‚«ãƒ¼
            const orderStartRow = document.createElement('div');
            orderStartRow.className = 'chart-row-cal';
            orderStartRow.innerHTML = '<div class="delivery-label-col">å…¨ä½“ç™ºæ³¨ START</div>';
            
            dateList.forEach(dateStr => {
                const cell = document.createElement('div');
                cell.className = 'task-cell';
                if (dateStr === globalStartDateStr) {
                    const mark = document.createElement('div');
                    mark.className = 'order-start-mark';
                    mark.textContent = 'START';
                    cell.appendChild(mark);
                }
                orderStartRow.appendChild(cell);
            });
            wrapper.appendChild(orderStartRow);

            chartContainer.appendChild(wrapper);
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨åˆæœŸåŒ– ---

        document.getElementById('add-process-btn').addEventListener('click', addProcessSetting);
        document.getElementById('apply-process-btn').addEventListener('click', applyProcessNamesToDeliveryGroups);
        document.getElementById('add-delivery-btn').addEventListener('click', function() {
            const d_index = deliveryContainer.children.length;
            addDeliveryGroup(d_index);
        });

        // è¨­å®šä¿å­˜/å°åˆ·ã‚¤ãƒ™ãƒ³ãƒˆã®è¿½åŠ 
        document.getElementById('save-config-btn').addEventListener('click', saveConfig);
        document.getElementById('load-config-btn').addEventListener('click', loadConfig);
        document.getElementById('print-gantt-btn').addEventListener('click', printGantt);

        document.addEventListener('DOMContentLoaded', function() {
            // 1. åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«å·¥ç¨‹è¨­å®šãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (Jinjaã‹ã‚‰ã®å€¤ã‚’åæ˜ )
            renderProcessSettingList();
            
            // 2. ç´å“å…ˆãŒã‚ã‚‹å ´åˆã€å·¥ç¨‹ãƒªã‚¹ãƒˆã‚’åæ˜ ã•ã›ã‚‹ï¼ˆç´å“å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å·¥ç¨‹åã¨æ—¥æ•°ã‚’ç¢ºå®šã•ã›ã‚‹ï¼‰
            if (deliveryContainer.children.length > 0) {
                 applyProcessNamesToDeliveryGroups(null); 
            }

            // 3. ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®æç”»
            if (document.getElementById('gantt-chart-simple')) {
                drawCalendarGantt();
            }
            
            // 4. ãƒ©ãƒ™ãƒ«ã®åˆæœŸæ›´æ–°
            updateDeliveryLabels(); 
        });
    </script>
</body>
</html>