<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–¬å±€ç´å“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«(Ver 5.0)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        .start-date-box { background-color: #e6ffe6; border: 1px solid #c6e6c6; padding: 20px; margin-bottom: 20px; text-align: center; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .gantt-chart-container { width: 100%; overflow-x: auto; margin-top: 20px; border: 1px solid #eee; padding: 15px; border-radius: 12px; background: #fff; }
        .delivery-box { border: 1px solid #e0e0e0; padding: 20px; margin-bottom: 25px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .process-input-group { margin-bottom: 8px; }
        h4 { color: #333; font-weight: bold; border-left: 5px solid #28a745; padding-left: 10px; margin-bottom: 20px; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h1 class="text-center mb-4">è–¬å±€ç´å“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
    <p class="text-center text-muted mb-5">Ver 5.0: æ¨ªå‹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º</p>
    
    <div class="start-date-box">
        <h5 class="text-muted">å…¨ä½“ã®ç™ºæ³¨é–‹å§‹æœŸé™ï¼ˆæœ€ã‚‚æ—©ã„æ—¥ï¼‰:</h5>
        <h2 class="text-success">{{ global_start_date if global_start_date else '---' }}</h2>
    </div>

    {% if all_schedules %}
    <div class="gantt-chart-container">
        <h5 class="mb-3">ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ¨ç§»</h5>
        <div id="timelineChart" style="width: 100%; min-height: 250px;"></div>
    </div>
    {% endif %}

    <div class="card p-4 mt-5 shadow-sm border-0">
        <h4>1. å·¥ç¨‹åã®å…±é€šè¨­å®š</h4>
        <div id="processNameContainer">
            {% for name in process_names_form %}
            <div class="input-group process-input-group">
                <input type="text" class="form-control" name="process_name[]" value="{{ name }}" required>
                <button type="button" class="btn btn-outline-danger remove-process-btn">å‰Šé™¤</button>
            </div>
            {% endfor %}
        </div>
        <button type="button" class="btn btn-outline-success btn-sm mt-2" id="addProcessBtn">+ å·¥ç¨‹ã‚’è¿½åŠ </button>
    </div>

    <form method="POST" id="mainForm" class="mt-4">
        <h4>2. ç´å“å…ˆã¨æ—¥æ•°ã®å…¥åŠ›</h4>
        <div id="deliveryContainer">
            {% for i in range(delivery_names_form|length) %}
            <div class="delivery-box" data-delivery-index="{{ i }}">
                <div class="row align-items-center mb-4">
                    <div class="col-md-5">
                        <label class="form-label font-weight-bold">ç´å“å…ˆå</label>
                        <input type="text" class="form-control" name="delivery_name[]" value="{{ delivery_names_form[i] }}" required>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label text-primary font-weight-bold">æœ€çµ‚ç´å“å¸Œæœ›æ—¥</label>
                        <input type="date" class="form-control border-primary" name="delivery_date_{{ i }}" value="{{ request.form.get('delivery_date_' ~ i) }}" required>
                    </div>
                    <div class="col-md-2 text-end pt-4">
                        <button type="button" class="btn btn-link text-danger remove-delivery-btn">å‰Šé™¤</button>
                    </div>
                </div>
                <table class="table table-sm bg-white">
                    <thead class="table-light"><tr><th>å·¥ç¨‹å</th><th>ä½œæ¥­æ—¥æ•°</th></tr></thead>
                    <tbody>
                        {% for p_index in range(process_names_form|length) %}
                        <tr>
                            <td class="align-middle">{{ process_names_form[p_index] }}</td>
                            <td>
                                <div class="input-group input-group-sm w-50">
                                    <input type="number" class="form-control" name="process_{{ p_index }}_days_{{ i }}" value="{{ process_days_form.get('process_' ~ p_index ~ '_days_' ~ i, '1') }}" min="0" required>
                                    <span class="input-group-text">æ—¥</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-5 mb-5">
            <button type="button" class="btn btn-success px-4" id="addDeliveryBtn">+ ç´å“å…ˆã‚’è¿½åŠ </button>
            <button type="submit" class="btn btn-primary btn-lg px-5 shadow">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é€†ç®—ã™ã‚‹</button>
        </div>
    </form>
</div>



<script>
    google.charts.load('current', {'packages':['timeline']});
    google.charts.setOnLoadCallback(drawChart);

    function parseDate(dateStr) {
        if (!dateStr) return null;
        const p = dateStr.split('-');
        return new Date(p[0], p[1] - 1, p[2]);
    }

    function drawChart() {
        const container = document.getElementById('timelineChart');
        if (!container) return;

        const chart = new google.visualization.Timeline(container);
        const dataTable = new google.visualization.DataTable();

        dataTable.addColumn({ type: 'string', id: 'Delivery' });
        dataTable.addColumn({ type: 'string', id: 'Process' });
        dataTable.addColumn({ type: 'date', id: 'Start' });
        dataTable.addColumn({ type: 'date', id: 'End' });

        const schedules = JSON.parse('{{ all_schedules | tojson | safe }}');
        const rows = [];

        schedules.forEach(delivery => {
            delivery.schedule.forEach(task => {
                rows.push([
                    delivery.delivery_name,
                    task.name,
                    parseDate(task.start),
                    parseDate(task.end)
                ]);
            });
        });

        if (rows.length === 0) return;
        dataTable.addRows(rows);

        const options = {
            height: schedules.length * 80 + 100,
            timeline: { 
                groupByRowLabel: true, // ã“ã‚Œã§æ¨ªã«ã¤ãªãŒã‚Šã¾ã™
                rowLabelStyle: { fontSize: 14 },
                barLabelStyle: { fontSize: 10 }
            }
        };

        chart.draw(dataTable, options);
    }

    // å·¥ç¨‹è¿½åŠ 
    document.getElementById('addProcessBtn').addEventListener('click', () => {
        const div = document.createElement('div');
        div.className = 'input-group process-input-group';
        div.innerHTML = '<input type="text" class="form-control" name="process_name[]" required><button type="button" class="btn btn-outline-danger remove-process-btn">å‰Šé™¤</button>';
        document.getElementById('processNameContainer').appendChild(div);
    });

    // å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆã®å§”è­²
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-process-btn')) {
            e.target.closest('.input-group').remove();
        }
        if (e.target.classList.contains('remove-delivery-btn')) {
            if(document.querySelectorAll('.delivery-box').length > 1) {
                e.target.closest('.delivery-box').remove();
            } else {
                alert("ç´å“å…ˆã¯æœ€ä½1ã¤å¿…è¦ã§ã™ã€‚");
            }
        }
    });

    // ç´å“å…ˆè¿½åŠ ï¼ˆä»Šå›ã¯ç°¡æ˜“çš„ã«å†è¨ˆç®—ã‚’ä¿ƒã™å½¢ã«ã—ã¦ã„ã¾ã™ï¼‰
    document.getElementById('addDeliveryBtn').addEventListener('click', () => {
        alert("ç¾åœ¨ã®è¨­å®šã§ä¸€åº¦ã€Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é€†ç®—ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ãã®å¾Œã€æ–°ã—ã„ç´å“å…ˆãŒè¿½åŠ å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚");
    });
</script>

</body>
</html>