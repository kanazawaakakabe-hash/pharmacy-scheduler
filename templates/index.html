<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>薬局納品スケジュールシミュレーター</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        .process-input-group {
            margin-bottom: 10px;
        }
        .gantt-chart-container {
            width: 100%;
            height: 600px; /* Google Chartsは高さが必要 */
            margin-top: 20px;
        }
        .start-date-box {
            background-color: #e6ffe6;
            border: 1px solid #c6e6c6;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .delivery-box {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f8f8f8;
        }
        .process-days-input {
            width: 80px;
        }
        .process-list-container {
            max-height: 400px; 
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h1 class="text-center mb-4">薬局納品スケジュールシミュレーター</h1>
    
    <div class="start-date-box">
        <h4>全納品先で最も早い発注開始日:</h4>
        <h2>{{ global_start_date if global_start_date else '納品希望日を入力してください' }}</h2>
    </div>

    {% if all_schedules %}
    <div class="gantt-chart-container">
        <div id="ganttChartDiv" style="width: 100%; height: 100%;"></div>
    </div>
    {% endif %}

    <h2 class="text-center mt-5 mb-3">薬局納品スケジュールシミュレーター (複数納品先対応)</h2>
    
    <hr>
    
    <div class="card p-3 mb-4">
        <h4 class="mb-3">工程名の設定</h4>
        <p class="text-muted">ここで工程名を設定した後、「スケジュールを逆算」ボタンを押してください。設定された工程名がすべての納品先グループに反映されます。</p>
        <div id="processNameContainer">
            {% for name in process_names_form %}
            <div class="input-group process-input-group">
                <input type="text" class="form-control process-name-input" 
                       name="process_name[]" value="{{ name }}" required>
                <button type="button" class="btn btn-danger remove-process-btn">削除</button>
            </div>
            {% endfor %}
            {% if not process_names_form %}
            {% set default_names = ['ピッキング', 'ピッキング監査', '一包化', '一包化監査', 'ホチキス・テープ止め', 'ホチキス・テープ止め監査', 'カレンダーセット', 'カレンダー監査'] %}
            {% for i in range(8) %}
                <div class="input-group process-input-group">
                    <input type="text" class="form-control process-name-input" 
                           name="process_name[]" value="{{ default_names[i] }}" required>
                    <button type="button" class="btn btn-danger remove-process-btn">削除</button>
                </div>
            {% endfor %}
            {% endif %}
        </div>
        <div class="mt-2">
            <button type="button" class="btn btn-success" id="addProcessBtn">工程を追加</button>
        </div>
    </div>

    <form method="POST" id="mainForm">
        
        <div id="deliveryContainer">
            {% for i in range(delivery_names_form|length) %}
            {% set delivery_name = delivery_names_form[i] %}
            {% set process_days_prefix = 'process_' %}
            
            <div class="delivery-box" data-delivery-index="{{ i }}">
                <div class="d-flex justify-content-between mb-3">
                    <h4>納品先 # {{ i + 1 }} :</h4>
                    <button type="button" class="btn btn-danger btn-sm remove-delivery-btn">削除</button>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">納品先名:</label>
                        <input type="text" class="form-control" name="delivery_name[]" value="{{ delivery_name }}" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">最終納品希望日:</label>
                        {% set delivery_date_key = 'delivery_date_' ~ i %}
                        <input type="date" class="form-control" name="{{ delivery_date_key }}" 
                               value="{{ request.form.get(delivery_date_key) }}" required>
                    </div>
                </div>

                <h5>工程スケジュール</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="width: 70%;">工程名</th>
                            <th style="width: 30%;">所要営業日数</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p_index in range(process_names_form|length) %}
                        <tr>
                            <td>{{ process_names_form[p_index] }}</td>
                            <td>
                                {% set days_key = process_days_prefix ~ p_index ~ '_days_' ~ i %}
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control process-days-input" 
                                           name="{{ days_key }}" 
                                           value="{{ process_days_form.get(days_key, '1') }}" 
                                           min="1" step="1" required>
                                    <span class="input-group-text">営業日</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
            
            {% if not delivery_names_form %}
            <div class="delivery-box" data-delivery-index="0">
                <div class="d-flex justify-content-between mb-3">
                    <h4>納品先 # 1 :</h4>
                    <button type="button" class="btn btn-danger btn-sm remove-delivery-btn">削除</button>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">納品先名:</label>
                        <input type="text" class="form-control" name="delivery_name[]" value="正徳円" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">最終納品希望日:</label>
                        <input type="date" class="form-control" name="delivery_date_0" required>
                    </div>
                </div>
                <h5>工程スケジュール</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="width: 70%;">工程名</th>
                            <th style="width: 30%;">所要営業日数</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set default_names = ['ピッキング', 'ピッキング監査', '一包化', '一包化監査', 'ホチキス・テープ止め', 'ホチキス・テープ止め監査', 'カレンダーセット', 'カレンダー監査'] %}
                        {% for p_index in range(8) %}
                        <tr>
                            <td>{{ default_names[p_index] }}</td>
                            <td>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control process-days-input" 
                                           name="process_{{ p_index }}_days_0" value="1" min="1" step="1" required>
                                    <span class="input-group-text">営業日</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>

        <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-success" id="addDeliveryBtn">納品先を追加</button>
            <button type="submit" class="btn btn-primary">スケジュールを逆算</button>
        </div>
    </form>
    
    <div class="start-date-box mt-5">
        <h4>全納品先で最も早い発注開始日:</h4>
        <h2>{{ global_start_date if global_start_date else '納品希望日を入力してください' }}</h2>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        let deliveryIndex = {{ delivery_names_form|length if delivery_names_form else 1 }};

        // ★★★ 修正済み：クラッシュの原因となった行を削除 ★★★

        // --- 納品先追加/削除機能 ---
        document.getElementById('addDeliveryBtn').addEventListener('click', function() {
            const deliveryContainer = document.getElementById('deliveryContainer');
            const newDeliveryIndex = deliveryContainer.children.length; 
            const processNames = Array.from(document.querySelectorAll('.process-name-input')).map(input => input.value);

            let newDeliveryHtml = `
            <div class="delivery-box" data-delivery-index="${newDeliveryIndex}">
                <div class="d-flex justify-content-between mb-3">
                    <h4>納品先 # ${newDeliveryIndex + 1} :</h4>
                    <button type="button" class="btn btn-danger btn-sm remove-delivery-btn">削除</button>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">納品先名:</label>
                        <input type="text" class="form-control" name="delivery_name[]" value="" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">最終納品希望日:</label>
                        <input type="date" class="form-control" name="delivery_date_${newDeliveryIndex}" required>
                    </div>
                </div>
                <h5>工程スケジュール</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="width: 70%;">工程名</th>
                            <th style="width: 30%;">所要営業日数</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            processNames.forEach((name, p_index) => {
                newDeliveryHtml += `
                    <tr>
                        <td>${name}</td>
                        <td>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control process-days-input" 
                                       name="process_${p_index}_days_${newDeliveryIndex}" value="1" min="1" step="1" required>
                                <span class="input-group-text">営業日</span>
                            </div>
                        </td>
                    </tr>
                `;
            });

            newDeliveryHtml += `
                    </tbody>
                </table>
            </div>
            `;
            
            deliveryContainer.insertAdjacentHTML('beforeend', newDeliveryHtml);
            deliveryIndex++;
            updateDeliveryIndexes();
        });

        document.getElementById('deliveryContainer').addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-delivery-btn')) {
                const deliveryBox = e.target.closest('.delivery-box');
                if (deliveryBox && document.getElementById('deliveryContainer').children.length > 1) {
                    deliveryBox.remove();
                    updateDeliveryIndexes();
                } else {
                    alert("納品先は最低1つ必要です。");
                }
            }
        });

        function updateDeliveryIndexes() {
            const boxes = document.querySelectorAll('.delivery-box');
            boxes.forEach((box, index) => {
                box.setAttribute('data-delivery-index', index);
                box.querySelector('h4').textContent = `納品先 # ${index + 1} :`;
                
                const deliveryDateInput = box.querySelector('input[name^="delivery_date_"]');
                if (deliveryDateInput) {
                    deliveryDateInput.name = `delivery_date_${index}`;
                }
                
                const processDaysInputs = box.querySelectorAll('input[name^="process_"]');
                processDaysInputs.forEach(input => {
                    const parts = input.name.split('_');
                    input.name = `process_${parts[1]}_days_${index}`;
                });
            });
            deliveryIndex = boxes.length;
        }

        // --- 工程名追加/削除機能 ---
        document.getElementById('addProcessBtn').addEventListener('click', function() {
            const container = document.getElementById('processNameContainer');
            const newProcessHtml = `
            <div class="input-group process-input-group">
                <input type="text" class="form-control process-name-input" 
                       name="process_name[]" value="" required>
                <button type="button" class="btn btn-danger remove-process-btn">削除</button>
            </div>
            `;
            container.insertAdjacentHTML('beforeend', newProcessHtml);
        });
        
        document.getElementById('processNameContainer').addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-process-btn')) {
                const inputGroup = e.target.closest('.input-group');
                if (inputGroup) {
                    inputGroup.remove();
                }
            }
        });
        
        // ★★★ 日付文字列を安全にDateオブジェクトに変換する関数 (変更なし) ★★★
        function parseDateString(dateStr) {
            // dateStr は 'YYYY-MM-DD' 形式を想定
            if (!dateStr) return null;
            const parts = dateStr.split('-');
            if (parts.length !== 3) return null;

            const year = parseInt(parts[0], 10);
            // JavaScriptの月は0始まり (0=1月, 11=12月) なので、月(1-12)から1を引く
            const month = parseInt(parts[1], 10) - 1; 
            const day = parseInt(parts[2], 10);
            
            // new Date() を使用してDateオブジェクトを構築
            return new Date(year, month, day);
        }

        // --- Google Chartsの描画関数 ★ 安全なパース処理を使用 (変更なし) ★ ---

        google.charts.load('current', {'packages':['gantt']});
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
            const container = document.getElementById('ganttChartDiv');
            if (!container) return;

            // Jinja2テンプレートからPythonのデータをJSONとして受け取り、JSオブジェクトにパース
            const schedules = JSON.parse('{{ all_schedules | tojson | safe }}');
            if (schedules.length === 0) return;

            const data = new google.visualization.DataTable();
            // カラム定義
            data.addColumn('string', 'Task ID');
            data.addColumn('string', 'Task Name');
            data.addColumn('string', 'Resource'); // 納品先名
            data.addColumn('date', 'Start Date');
            data.addColumn('date', 'End Date');
            data.addColumn('number', 'Duration'); 
            data.addColumn('number', 'Percent Complete'); 
            data.addColumn('string', 'Dependencies'); 

            let rowCount = 0;

            schedules.forEach((delivery, deliveryIndex) => {
                const deliveryName = delivery.delivery_name || `納品先 ${deliveryIndex + 1}`;
                
                // 1. 全体発注START（マーカー）
                const startDateObj = parseDateString(delivery.start_date);

                if (startDateObj) {
                    data.addRow([
                        `Start-${deliveryIndex}`, 
                        `【START】`,
                        deliveryName,
                        startDateObj, 
                        startDateObj, 
                        1000 * 60 * 60 * 24 * 0.1, // 期間を短く設定（1日の1/10）
                        0, 
                        null
                    ]);
                    rowCount++;
                }


                // 2. 各工程のスケジュール
                delivery.schedule.forEach((task, taskIndex) => {
                    const taskId = `${deliveryIndex}-${taskIndex}`;
                    const taskStartDate = parseDateString(task.start);
                    const taskEndDate = parseDateString(task.end);
                    
                    if (taskStartDate && taskEndDate) {
                         data.addRow([
                            taskId,
                            task.name,
                            deliveryName,
                            taskStartDate,   // 安全にパースしたDateオブジェクト
                            taskEndDate,     // 安全にパースしたDateオブジェクト
                            null,            // Durationは自動計算
                            100,             // 100%完了 (バーとして表示)
                            (taskIndex > 0) ? `${deliveryIndex}-${taskIndex - 1}` : `Start-${deliveryIndex}` // 依存関係
                        ]);
                        rowCount++;
                    }
                });

                // 3. 納品日（マーカー）
                const deliveryDateObj = parseDateString(delivery.delivery_date);
                const lastTaskId = `${deliveryIndex}-${delivery.schedule.length - 1}`;
                
                if (deliveryDateObj) {
                     data.addRow([
                        `Delivery-${deliveryIndex}`, 
                        `【納品】`,
                        deliveryName,
                        deliveryDateObj,
                        deliveryDateObj,
                        1000 * 60 * 60 * 24 * 0.1, // 期間を短く設定
                        100, 
                        lastTaskId
                    ]);
                    rowCount++;
                }

            });
            
            // オプション設定
            const options = {
                height: 50 + (rowCount * 40), 
                gantt: {
                    // defaultStartDate もパースした値を使用
                    defaultStartDate: schedules.length > 0 ? parseDateString(schedules[0].start_date) : new Date(),
                    criticalPathEnabled: false, 
                    arrow: {
                        angle: 100,
                        width: 5,
                        color: 'red',
                        radius: 0
                    },
                    barCornerRadius: 4,
                    // カラーパレット (タスクの種類ごとに色分けされます)
                    palette: [
                        { "color": "#1f77b4" }, 
                        { "color": "#ff7f0e" }, 
                        { "color": "#2ca02c" }, 
                        { "color": "#d62728" },
                        { "color": "#9467bd" },
                        { "color": "#8c564b" },
                        { "color": "#e377c2" },
                        { "color": "#7f7f7f" }
                    ]
                }
            };

            const chart = new google.visualization.Gantt(container);
            chart.draw(data, options);
        }

        // ... (後略：UI操作用のJavaScriptコード) ...

    });
</script>

</body>
</html>